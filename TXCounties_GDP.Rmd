---
title: "Texas County GDP"
author: "Shannon Carter"
date: "1/23/2020"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
knitr::opts_knit$set(root.dir = "/Users/shannoncarter/Documents/JanuaryAdvisors/GDP_Counties")


```


```{r prep workspace}
## Set working directory and clear memory
setwd("/Users/shannoncarter/Documents/JanuaryAdvisors/GDP_Counties")
rm(list = ls(all = T))

## Load required packages
library(tidyverse)
library(tigris)
library(extrafont)
library(usmap)
library(maps)
library(magrittr)
library(leaflet)

## Load data
tx <- read.csv("TXCounty_GDP.csv", header = T)
gdp_ind <- read.csv("gdp_industry_clean.csv", header = T)

## Plotting style elements
mytheme <- theme_bw(base_size = 15, base_family = "Franklin Gothic Medium") +
  theme(legend.text = element_text(size = 10),
        legend.title = element_text(size = 11),
        text = element_text(size = 14),     
        axis.title = element_text(size = 12),
        axis.text  = element_text(size = 8, family = "Consolas"),
        panel.grid = element_blank())
```

```{r}
head(tx)
head(gdp_ind)
```

# Clean TX county GDP summaries

```{r}
# trim to raw gdp only
tx_gdp <- tx[,1:5]

# gather by year
tx_gdp_long <- gather(tx_gdp, key = "year", value = "gdp", -county)
tx_gdp_long <- separate(tx_gdp_long, year, into = c(NA, "year"), sep = "_")

# change data types
tx_gdp_long$year <- as.numeric(tx_gdp_long$year)
tx_gdp_long$gdp <- gsub(",", "", tx_gdp_long$gdp)
tx_gdp_long$gdp <- as.numeric(tx_gdp_long$gdp)
head(tx_gdp_long)
```

# Clean TX county GDP by industry

```{r}
# Remove all rows containing "addendum"
gdp_ind[!grepl("addendum", gdp_ind$Description),]

# Make all missing values NA
gdp_ind <- gdp_ind %>% 
  dplyr::na_if("(NA)") %>% 
  dplyr::na_if("(D)")

# Trim ", TX" out of county name
gdp_ind <- separate(gdp_ind, "county", into = c("county", NA), sep = ",")

# Select only private industries and give shorthand name for each
gdp_ind <- gdp_ind %>% 
  filter(industry_code == c(3, 6, 10:12, 34:36, 45, 50, 59, 68, 75, 82)) %>% 
  mutate(industry_short = case_when(
    industry_code == 3 ~ "agriculture",
    industry_code == 6 ~ 'mining',
    industry_code == 10 ~ 'utilities',
    industry_code == 11 ~ 'construction',
    industry_code == 12 ~ 'manufacturing',
    industry_code == 34 ~ 'wholesale',
    industry_code == 35 ~ 'retail',
    industry_code == 36 ~ 'transportation',
    industry_code == 45 ~ 'information',
    industry_code == 50 ~ 'finance_etc',
    industry_code == 59 ~ 'business_servs',
    industry_code == 68 ~ 'education',
    industry_code == 75 ~ 'arts',
    industry_code == 82 ~ 'other'))

```


```{r}
ggplot(tx_gdp_long, aes(x = year, y = gdp, color = county)) + mytheme +
  geom_point() +
  geom_line() +
  theme(legend.position = "none")
```

```{r}
# add a delta gdp column
tx_gdp_delta <- tx_gdp_long %>% 
  filter(year != 2016 & year != 2017) %>% 
  spread(year, gdp)

tx_gdp_delta$delta_gdp <- (tx_gdp_delta[,3] - tx_gdp_delta[,2])/(tx_gdp_delta[,2])

ggplot(tx_gdp_delta, aes(x = reorder(county, delta_gdp), y = delta_gdp)) +
  geom_point(color = 'orange') +
  geom_hline(yintercept = 0, color = 'lightgray', linetype = 2) +
  mytheme +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0)) +
  labs(x = "county",
       y = "proportional change in GDP from 2015-2018")
```

```{r}

plot_usmap(regions = "counties", include = "TX") + 
  labs(title = "TX Counties",
       subtitle = "This is a blank map of the counties of Texas.") + 
  theme(panel.background = element_rect(color = "black", fill = "lightblue"))

tx_counties <- usmap::us_map(regions = "counties", include = "TX")
tx_counties <- separate(tx_counties, county, into = c("county", NA), sep = " ")
```

```{r}
# join county data with gdp data
tx_gdp_county <- left_join(tx_gdp_delta, tx_counties, by = 'county')
```

```{r}

plot_usmap(data = tx_gdp_county, values = "delta_gdp") + 
  scale_fill_continuous() + 
  theme(legend.position = "right")
```
```{r}
leaflet(options = leafletOptions(minZoom = 0, maxZoom = 18))
mapStates = maps::map("state", fill = TRUE, plot = FALSE)
basic <- leaflet(data = mapStates) %>% 
  addTiles() %>%
  addPolygons(fillColor = topo.colors(10, alpha = NULL), stroke = FALSE)
```
```{r}
m = leaflet() %>% addTiles()
df = data.frame(
  lat = rnorm(100),
  lng = rnorm(100),
  size = runif(100, 5, 20),
  color = sample(colors(), 100)
)
m = leaflet(df) %>% addTiles()
m %>% addCircleMarkers(radius = ~size, color = ~color, fill = FALSE)
m %>% addCircleMarkers(radius = runif(100, 4, 10), color = c('red'))
```




